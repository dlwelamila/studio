rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions to promote readable and reusable rules.
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    function isApprovedHelper() {
        return isSignedIn() && get(/databases/$(database)/documents/helpers/$(request.auth.uid)).data.verificationStatus == 'APPROVED';
    }

    function isAssignedHelper(taskData) {
      return isSignedIn() && taskData.assignedHelperId == request.auth.uid;
    }
    
    function isResourceOwner(resource, key) {
        return isSignedIn() && resource.data[key] == request.auth.uid;
    }

    function isCreatingOwnResource(key) {
      return isSignedIn() && request.resource.data[key] == request.auth.uid;
    }

    function ownerFieldIsImmutable(key) {
      return request.resource.data[key] == resource.data[key];
    }
    
    function canUpdateTaskStatus(currentStatus, nextStatus) {
      // Helper transitions
      return (currentStatus == 'ASSIGNED' && nextStatus == 'ACTIVE') ||
             (currentStatus == 'ACTIVE' && nextStatus == 'COMPLETED');
    }
    
    function customerCanDispute(currentStatus, nextStatus) {
      // Customer transition
      return currentStatus == 'COMPLETED' && nextStatus == 'IN_DISPUTE';
    }

    match /customers/{userId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && ownerFieldIsImmutable('id');
      allow delete: if isOwner(userId);
    }
    
    match /helpers/{userId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && ownerFieldIsImmutable('id');
      allow delete: if isOwner(userId);
    }

    match /tasks/{taskId} {
      // Allow list for all signed-in users (feed), but get is restricted.
      allow list: if isSignedIn();
      
      // Get is allowed if task is OPEN, or if user is owner/assigned helper.
      allow get: if isSignedIn() && (
        resource.data.status == 'OPEN' || 
        isResourceOwner(resource, 'customerId') || 
        isAssignedHelper(resource.data)
      );

      allow create: if isCreatingOwnResource('customerId') && exists(/databases/$(database)/documents/customers/$(request.auth.uid));
      
      allow update: if isSignedIn() && (
        // Customer can accept an offer or dispute a completed task
        (isResourceOwner(resource, 'customerId') && (
            ownerFieldIsImmutable('customerId') || 
            customerCanDispute(resource.data.status, request.resource.data.status)
        )) ||
        // Helper can update status (ASSIGNED -> ACTIVE -> COMPLETED)
        (isAssignedHelper(resource.data) && canUpdateTaskStatus(resource.data.status, request.resource.data.status) && ownerFieldIsImmutable('customerId') && ownerFieldIsImmutable('assignedHelperId')) ||
        // Helper can check in (add arrivedAt and update status)
        (isAssignedHelper(resource.data) && resource.data.status == 'ASSIGNED' && request.resource.data.keys().hasAll(['arrivedAt', 'status']))
      );
      
      allow delete: if isResourceOwner(resource, 'customerId');

      // Offers subcollection
      match /offers/{offerId} {
        allow get, list: if isResourceOwner(get(/databases/$(database)/documents/tasks/$(taskId)), 'customerId') || isAdmin() || isCreatingOwnResource('helperId');
        allow create: if isCreatingOwnResource('helperId') && isApprovedHelper();
        allow update: if isResourceOwner(resource, 'helperId') && ownerFieldIsImmutable('helperId');
        allow delete: if isResourceOwner(resource, 'helperId');
      }
    }
    
    match /task_chats/{chatId} {
      allow get, update: if isSignedIn() && request.auth.uid in resource.data.participantIds;
      allow create: if isCreatingOwnResource('customerId');
      // A user can only list chats if their query filters for chats where they are a participant.
      allow list: if isSignedIn() && request.query.where.get('participantIds', ['array-contains', '']) == [request.auth.uid];

      match /messages/{messageId} {
        allow get, list: if isSignedIn() && request.auth.uid in get(/databases/$(database)/documents/task_chats/$(chatId)).data.participantIds;
        allow create: if isCreatingOwnResource('senderId') && request.auth.uid in get(/databases/$(database)/documents/task_chats/$(chatId)).data.participantIds;
      }
    }
    
    match /feedbacks/{feedbackId} {
       allow get, list: if true;
       allow create: if isCreatingOwnResource('customerId');
       allow update, delete: if false; // Feedback is immutable
    }

    match /support_tickets/{ticketId} {
      allow get, list, update, delete: if isAdmin();
      allow create: if isCreatingOwnResource('userId');
    }

    match /roles_admin/{userId} {
      allow get, list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }
  }
}