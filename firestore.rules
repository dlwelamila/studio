/**
 * Core Philosophy: This ruleset implements a multi-role security model for a task marketplace application,
 * catering to Customers, Helpers, and Admins. The primary goal is to enforce strict data ownership and role-based
 * access while maintaining flexibility for rapid development (Prototyping Mode).
 *
 * Data Structure: The data is organized into top-level collections for different user types (/customers, /helpers),
 * core business objects (/tasks, /feedbacks), and administration (/roles_admin). Offers are nested as a
 * subcollection under their parent task (/tasks/{taskId}/offers/{offerId}) to maintain a clear relational link.
 *
 * Key Security Decisions:
 * - Strict Ownership: A user's private data (e.g., in /customers/{userId}) is only accessible by that user.
 * - Public vs. Private Data: Publicly consumable data like tasks and feedback are readable by any signed-in user,
 *   but write operations are strictly limited to the document owner or an authorized role (e.g., an assigned helper).
 * - Admin Privileges: A user is granted global admin rights by the existence of a document with their UID in the
 *   /roles_admin collection. Admins have read and write access to all data.
 * - User Enumeration: Listing users from the /customers or /helpers collections is disallowed to protect user privacy.
 *
 * Denormalization for Authorization: To ensure performant and secure rules, ownership and relationship data is
 * denormalized directly onto documents. For example, a 'Task' document contains a `customerId` field, and an 'Offer'
 * contains a `helperId`. This avoids slow and costly `get()` calls in most security rules.
 *
 * Structural Segregation: User profiles for Customers and Helpers are stored in separate top-level collections.
 * This allows for distinct security rules and data models for each user type, enhancing clarity and security.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * This is the fundamental check for document ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the user is an administrator by verifying the existence of their
     * UID in the /roles_admin collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * A robust ownership check for update/delete operations, ensuring the document
     * exists before attempting to apply the rule.
     */
    function isExistingOwner(userId) {
      return resource != null && isOwner(userId);
    }

    /**
     * Validates that a user is creating their own profile document and that the
     * document's internal `id` field correctly matches their auth UID.
     */
    function isCreatingOwnProfile(userId) {
      return isOwner(userId) && request.resource.data.id == userId;
    }

    /**
     * Enforces immutability of the primary ID field on a profile document during an update.
     */
    function profileIdIsImmutable() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates that the `customerId` on a new task matches the creator's UID.
     */
    function isCreatingOwnTask() {
      return isSignedIn() && request.resource.data.customerId == request.auth.uid;
    }

    /**
     * Checks if the user is the customer who created the task.
     */
    function isTaskOwner() {
        return resource != null && isOwner(resource.data.customerId);
    }
    
    /**
     * Checks if the user is the helper assigned to the task.
     */
    function isAssignedHelper() {
        return resource != null && isOwner(resource.data.assignedHelperId);
    }

    /**
     * Validates a helper is updating the task status correctly (ASSIGNED -> IN_PROGRESS -> COMPLETED)
     */
    function isValidStatusUpdateByHelper() {
        let isUpdatingStatus = request.resource.data.keys().hasOnly(['status']) || request.resource.data.keys().hasAll(['status', 'completedAt']);
        let currentStatus = resource.data.status;
        let nextStatus = request.resource.data.status;
        
        let validTransitions = 
            (currentStatus == 'ASSIGNED' && nextStatus == 'IN_PROGRESS') ||
            (currentStatus == 'IN_PROGRESS' && nextStatus == 'COMPLETED');
            
        return isAssignedHelper() && isUpdatingStatus && validTransitions;
    }

    /**
     * Validates a customer is assigning a helper.
     */
    function isValidAssignmentByCustomer() {
        let isAssigning = request.resource.data.keys().hasAll(['status', 'assignedHelperId']);
        return isTaskOwner() && isAssigning && request.resource.data.status == 'ASSIGNED';
    }


    /**
     * Validates that a helper is creating an offer for an existing task and
     * correctly self-identifies as the `helperId`.
     */
    function isCreatingOwnOffer(taskId) {
      let taskExists = exists(/databases/$(database)/documents/tasks/$(taskId));
      return isSignedIn() && taskExists && request.resource.data.helperId == request.auth.uid;
    }

    /**
     * Checks if the current user is the owner of the parent task document.
     * Used to grant access to the offers subcollection.
     */
    function isParentTaskOwner(taskId) {
      let taskData = get(/databases/$(database)/documents/tasks/$(taskId)).data;
      return isOwner(taskData.customerId);
    }

    /**
     * Validates that feedback is being created by the same customer who owns the
     * associated task, preventing fraudulent reviews.
     */
    function isCreatingValidFeedback() {
      let task = get(/databases/$(database)/documents/tasks/$(request.resource.data.taskId));
      return isSignedIn() && task != null && isOwner(task.data.customerId) && isOwner(request.resource.data.customerId);
    }


    // --------------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------------

    /**
     * @description Controls access to private customer profiles.
     * @path /customers/{customerId}
     * @allow (create) An authenticated user creating their own profile document.
     * @deny (get) A user trying to read another user's profile.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId) || isAdmin();
      allow list: if false; // Disallow listing customers to protect privacy
      allow create: if isCreatingOwnProfile(customerId);
      allow update: if (isExistingOwner(customerId) || isAdmin()) && profileIdIsImmutable();
      allow delete: if isExistingOwner(customerId) || isAdmin();
    }

    /**
     * @description Controls access to private helper profiles.
     * @path /helpers/{helperId}
     * @allow (create) An authenticated user creating their own helper profile.
     * @deny (get) A user trying to read another helper's profile.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /helpers/{helperId} {
      allow get: if isOwner(helperId) || isAdmin();
      allow list: if false; // Disallow listing helpers to protect privacy
      allow create: if isCreatingOwnProfile(helperId);
      allow update: if (isExistingOwner(helperId) || isAdmin()) && profileIdIsImmutable();
      allow delete: if isExistingOwner(helperId) || isAdmin();
    }

    /**
     * @description Controls access to tasks. Tasks are viewable by any signed-in user, but only the
     * owner (customer) or assigned helper can modify them.
     * @path /tasks/{taskId}
     * @allow (get) Any authenticated user can read a task's details.
     * @deny (delete) A helper trying to delete a task they are assigned to.
     * @principle Enforces document ownership for destructive actions, while allowing broader read access.
     */
    match /tasks/{taskId} {
      allow get, list: if isSignedIn() || isAdmin();
      allow create: if isCreatingOwnTask();
      allow update: if isValidAssignmentByCustomer() || isValidStatusUpdateByHelper() || isAdmin();
      allow delete: if isTaskOwner() || isAdmin();

      /**
       * @description Controls access to offers made on a task.
       * @path /tasks/{taskId}/offers/{offerId}
       * @allow (create) A helper creating an offer on an existing task.
       * @deny (list) A helper trying to list all offers on a task to see competitors.
       * @principle Implements shared access between the task owner and the offer creator.
       */
      match /offers/{offerId} {
        allow get: if (resource != null && isOwner(resource.data.helperId)) || isParentTaskOwner(taskId) || isAdmin();
        allow list: if isParentTaskOwner(taskId) || isAdmin();
        allow create: if isCreatingOwnOffer(taskId);
        allow update: if (isExistingOwner(resource.data.helperId) || isAdmin() || isParentTaskOwner(taskId));
        allow delete: if (isExistingOwner(resource.data.helperId) || isAdmin());
      }
    }

    /**
     * @description Controls access to feedback. Feedback is publicly viewable by signed-in users,
     * but can only be created and managed by the customer who posted the original task.
     * @path /feedbacks/{feedbackId}
     * @allow (get) Any authenticated user can read feedback.
     * @deny (create) A user trying to leave feedback for a task they did not create.
     * @principle Public read with owner-only writes, with relational validation.
     */
    match /feedbacks/{feedbackId} {
      allow get, list: if isSignedIn() || isAdmin();
      allow create: if isCreatingValidFeedback();
      allow update: if (isExistingOwner(resource.data.customerId) || isAdmin());
      allow delete: if (isExistingOwner(resource.data.customerId) || isAdmin());
    }

    /**
     * @description Manages administrator roles. Only existing admins can read or modify this collection.
     * @path /roles_admin/{uid}
     * @allow (get) An admin reading the roles collection.
     * @deny (create) A non-admin user trying to grant themselves admin privileges.
     * @principle Secures administrative roles by restricting all access to current admins only.
     */
    match /roles_admin/{uid} {
      allow get, list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }
  }
}
