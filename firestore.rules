rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // --------------------------------------------------------------------------------
    // Collection: helpers
    // --------------------------------------------------------------------------------
    match /helpers/{helperId} {
      // Any authenticated user can view a helper's public profile.
      allow get: if isSignedIn();
      // Helpers cannot list other helpers.
      allow list: if false;
      // A helper can update their own profile.
      allow update: if isOwner(helperId);
      // A helper can create their own profile, ensuring the ID matches their auth UID.
      allow create: if isOwner(helperId) && request.resource.data.id == helperId;
    }

    // --------------------------------------------------------------------------------
    // Collection: customers
    // --------------------------------------------------------------------------------
    match /customers/{customerId} {
      // Any signed-in user can view a customer's public profile.
      allow get: if isSignedIn();
      // A customer can create and update their own profile.
      allow create, update: if isOwner(customerId) && request.resource.data.id == customerId;
    }
    
    // --------------------------------------------------------------------------------
    // Collection: tasks
    // --------------------------------------------------------------------------------
    match /tasks/{taskId} {
      // Any signed-in helper can read OPEN tasks. 
      // The customer who owns the task or the assigned helper can read it regardless of status.
      allow get: if isSignedIn() && (resource.data.status == 'OPEN' || isOwner(resource.data.customerId) || isOwner(resource.data.assignedHelperId));
      
      // Any signed-in helper can list (browse) OPEN tasks.
      allow list: if isSignedIn() && request.query.where.to_list().join("").matches(".*status.*OPEN.*");

      // Customers can create tasks. Helpers cannot.
      allow create: if isOwner(request.resource.data.customerId);

      // A customer can update their own task if it's still OPEN.
      // An assigned helper can update a task assigned to them.
      allow update: if (isOwner(resource.data.customerId) && resource.data.status == 'OPEN') || isOwner(resource.data.assignedHelperId);
      
      // A customer can cancel their own task.
      allow delete: if isOwner(resource.data.customerId);
      
      // --- Subcollection: offers ---
      match /offers/{offerId} {
        // A helper can create an offer on a task.
        allow create: if isOwner(request.resource.data.helperId);
        
        // The helper who made the offer or the customer who owns the task can read the offer.
        allow get: if isOwner(resource.data.helperId) || isOwner(get(/databases/$(database)/documents/tasks/$(taskId)).data.customerId);
        
        // A helper can update/withdraw their own offer if its status is ACTIVE.
        allow update, delete: if isOwner(resource.data.helperId) && resource.data.status == 'ACTIVE';

        // Helpers cannot see other helpers' offers. Customers list offers on the client.
        allow list: if false;
      }
    }
    
    // --------------------------------------------------------------------------------
    // Collection: reviews
    // --------------------------------------------------------------------------------
    match /reviews/{reviewId} {
      // Any authenticated user can read reviews.
      allow get, list: if isSignedIn();
      // A customer can create a review for a task they posted.
      allow create: if isOwner(request.resource.data.customerId);
      // Reviews are immutable.
      allow update, delete: if false;
    }
  }
}
